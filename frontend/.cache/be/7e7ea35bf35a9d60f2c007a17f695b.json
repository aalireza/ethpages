{"id":"node_modules/uport-transports/lib/transport/messageServer.js","dependencies":[{"name":"/Users/sashavol/Misc/ethdenver-keybook/frontend/package.json","includedInParent":true,"mtime":1550371955498},{"name":"/Users/sashavol/Misc/ethdenver-keybook/frontend/node_modules/uport-transports/package.json","includedInParent":true,"mtime":1550368277431},{"name":"/Users/sashavol/Misc/ethdenver-keybook/frontend/node_modules/uport-transports/.babelrc","includedInParent":true,"mtime":499162500000},{"name":"./../message/util.js","loc":{"line":8,"column":20},"parent":"/Users/sashavol/Misc/ethdenver-keybook/frontend/node_modules/uport-transports/lib/transport/messageServer.js","resolved":"/Users/sashavol/Misc/ethdenver-keybook/frontend/node_modules/uport-transports/lib/message/util.js"},{"name":"./../crypto.js","loc":{"line":10,"column":22},"parent":"/Users/sashavol/Misc/ethdenver-keybook/frontend/node_modules/uport-transports/lib/transport/messageServer.js","resolved":"/Users/sashavol/Misc/ethdenver-keybook/frontend/node_modules/uport-transports/lib/crypto.js"},{"name":"./poll.js","loc":{"line":12,"column":20},"parent":"/Users/sashavol/Misc/ethdenver-keybook/frontend/node_modules/uport-transports/lib/transport/messageServer.js","resolved":"/Users/sashavol/Misc/ethdenver-keybook/frontend/node_modules/uport-transports/lib/transport/poll.js"},{"name":"did-jwt","loc":{"line":16,"column":22},"parent":"/Users/sashavol/Misc/ethdenver-keybook/frontend/node_modules/uport-transports/lib/transport/messageServer.js","resolved":"/Users/sashavol/Misc/ethdenver-keybook/frontend/node_modules/did-jwt/lib/index.js"},{"name":"nets","loc":{"line":18,"column":20},"parent":"/Users/sashavol/Misc/ethdenver-keybook/frontend/node_modules/uport-transports/lib/transport/messageServer.js","resolved":"/Users/sashavol/Misc/ethdenver-keybook/frontend/node_modules/nets/index.js"}],"generated":{"js":"'use strict';\n\nObject.defineProperty(exports, \"__esModule\", {\n  value: true\n});\nexports.CHASQUI_URL = exports.isMessageServerCallback = exports.genCallback = exports.clearResponse = exports.poll = exports.URIHandlerSend = undefined;\n\nvar _util = require('./../message/util.js');\n\nvar _crypto = require('./../crypto.js');\n\nvar _poll = require('./poll.js');\n\nvar _poll2 = _interopRequireDefault(_poll);\n\nvar _didJwt = require('did-jwt');\n\nvar _nets = require('nets');\n\nvar _nets2 = _interopRequireDefault(_nets);\n\nfunction _interopRequireDefault(obj) { return obj && obj.__esModule ? obj : { default: obj }; }\n\nvar CHASQUI_URL = 'https://api.uport.space/chasqui/';\nvar POLLING_INTERVAL = 2000;\n\n// TODO can the name of URIHandler be changed\n// TODO should it just allow cancel func to be passed in??\n// TODO Should it return uri append to promise? instead of a promise??\n/**\n *  A general Chasqui Transport. Allows you to configure the transport with any uriHandler for the request,\n *  while the response will always be returned through Chasqui. Chasqui is a simple messaging server that\n *  allows responses to be relayed from a uport client to the original callee.\n *\n *  @param    {String}       uriHandler               a function called with the requestURI once it is formatted for this transport\n *  @param    {Object}       [config={}]              an optional config object\n *  @param    {String}       [config.chasquiUrl]      url of messaging server, defaults to Chasqui instance run by uPort\n *  @param    {String}       [config.pollingInterval] milisecond interval at which the messaging server will be polled for a response\n *  @return   {Function}                              a configured QRTransport Function\n *  @param    {String}       message                  a uPort client request message\n *  @return   {Promise<Object, Error>}                a function to close the QR modal\n */\nvar URIHandlerSend = function URIHandlerSend(uriHandler) {\n  var _ref = arguments.length > 1 && arguments[1] !== undefined ? arguments[1] : {},\n      _ref$messageServerUrl = _ref.messageServerUrl,\n      messageServerUrl = _ref$messageServerUrl === undefined ? CHASQUI_URL : _ref$messageServerUrl,\n      _ref$pollingInterval = _ref.pollingInterval,\n      pollingInterval = _ref$pollingInterval === undefined ? POLLING_INTERVAL : _ref$pollingInterval;\n\n  if (!uriHandler) throw new Error('uriHandler function required');\n  return function (message) {\n    var params = arguments.length > 1 && arguments[1] !== undefined ? arguments[1] : {};\n\n    var uri = (0, _util.messageToURI)(message);\n    var callback = getCallback(uri);\n    if (!isMessageServerCallback(uri, messageServerUrl)) throw new Error('Not a request that can be handled by this configured messaging server transport');\n    var isCancelled = false;\n    var cancel = function cancel() {\n      isCancelled = true;\n    };\n    uri = (0, _util.paramsToQueryString)(uri, { callback_type: 'post' });\n    uriHandler(uri, Object.assign(params, { cancel: cancel }));\n    var returnVal = poll(callback, pollingInterval, function () {\n      return isCancelled;\n    });\n    returnVal.cancel = cancel;\n    return returnVal;\n  };\n};\n\n/**\n *  A polling function specifically for polling Chasqui.\n *\n *  @param    {String}                  url                a Chasqui url polled\n *  @param    {Integer}                 [pollingInterval]  ms interval at which the given url is polled\n *  @param    {Function}                [cancelled]        function which returns boolean, if returns true, polling stops\n *  @return   {Promise<Object, Error>}                     a promise which resolves with obj/message or rejects with an error\n */\nvar poll = function poll(url, pollingInterval, cancelled) {\n  var messageParse = function messageParse(res) {\n    // Support new and old chasqui format\n    var message = res.message && ('content' in res.message ? JSON.parse(res.message.content) : res.message);\n    // FIXME: this is not a great method for handling our expected keys in the response.\n    //        Very tightly coupled to the message format, and these keys seem to come out\n    //        of nowhere.\n    if (message) {\n      return message['access_token'] || message['tx'] || message['typedDataSig'] || message['personalSig'];\n    }\n  };\n  var errorParse = function errorParse(res) {\n    if (res.message) return res.message.error;\n  };\n  return (0, _poll2.default)(url, messageParse, errorParse, cancelled, pollingInterval).then(function (res) {\n    clearResponse(url);\n    return res;\n  });\n};\n\n// TODO maybe remove and just have reasonable removal times\nvar clearResponse = function clearResponse(url) {\n  (0, _nets2.default)({\n    uri: url,\n    method: 'DELETE',\n    withCredentials: false,\n    rejectUnauthorized: false\n  }, function (err) {\n    if (err) {\n      throw err;\n    } /* Errors without this cb */\n  });\n};\n\nvar formatMessageServerUrl = function formatMessageServerUrl(url) {\n  if (url.endsWith('/topic/')) return url;\n  if (url.endsWith('/topic')) return url + '/';\n  if (url.endsWith('/')) return url + 'topic/';\n  return url + '/topic/';\n};\nvar genCallback = function genCallback() {\n  var messageServerUrl = arguments.length > 0 && arguments[0] !== undefined ? arguments[0] : CHASQUI_URL;\n  return '' + formatMessageServerUrl(messageServerUrl) + (0, _crypto.randomString)(16);\n};\nvar isMessageServerCallback = function isMessageServerCallback(uri) {\n  var messageServerUrl = arguments.length > 1 && arguments[1] !== undefined ? arguments[1] : CHASQUI_URL;\n  return new RegExp(formatMessageServerUrl(messageServerUrl)).test(getCallback(uri));\n};\nvar getCallback = function getCallback(uri) {\n  var tokenCB = (0, _didJwt.decodeJWT)((0, _util.getURLJWT)(uri)).payload.callback;\n  if (tokenCB) return tokenCB;\n  // support attest req, which does not included cb in token, attest req may better align with other requests in the future\n  return (0, _util.getUrlQueryParams)(uri).callback_url;\n};\n\nexports.URIHandlerSend = URIHandlerSend;\nexports.poll = poll;\nexports.clearResponse = clearResponse;\nexports.genCallback = genCallback;\nexports.isMessageServerCallback = isMessageServerCallback;\nexports.CHASQUI_URL = CHASQUI_URL;","map":{"mappings":[{"source":"node_modules/uport-transports/lib/transport/messageServer.js","original":{"line":1,"column":0},"generated":{"line":1,"column":0}},{"source":"node_modules/uport-transports/lib/transport/messageServer.js","original":{"line":2,"column":0},"generated":{"line":2,"column":0}},{"source":"node_modules/uport-transports/lib/transport/messageServer.js","original":{"line":3,"column":0},"generated":{"line":3,"column":0}},{"source":"node_modules/uport-transports/lib/transport/messageServer.js","original":{"line":4,"column":0},"generated":{"line":4,"column":0}},{"source":"node_modules/uport-transports/lib/transport/messageServer.js","original":{"line":5,"column":0},"generated":{"line":5,"column":0}},{"source":"node_modules/uport-transports/lib/transport/messageServer.js","original":{"line":6,"column":0},"generated":{"line":6,"column":0}},{"source":"node_modules/uport-transports/lib/transport/messageServer.js","original":{"line":7,"column":0},"generated":{"line":7,"column":0}},{"source":"node_modules/uport-transports/lib/transport/messageServer.js","original":{"line":8,"column":0},"generated":{"line":8,"column":0}},{"source":"node_modules/uport-transports/lib/transport/messageServer.js","original":{"line":9,"column":0},"generated":{"line":9,"column":0}},{"source":"node_modules/uport-transports/lib/transport/messageServer.js","original":{"line":10,"column":0},"generated":{"line":10,"column":0}},{"source":"node_modules/uport-transports/lib/transport/messageServer.js","original":{"line":11,"column":0},"generated":{"line":11,"column":0}},{"source":"node_modules/uport-transports/lib/transport/messageServer.js","original":{"line":12,"column":0},"generated":{"line":12,"column":0}},{"source":"node_modules/uport-transports/lib/transport/messageServer.js","original":{"line":13,"column":0},"generated":{"line":13,"column":0}},{"source":"node_modules/uport-transports/lib/transport/messageServer.js","original":{"line":14,"column":0},"generated":{"line":14,"column":0}},{"source":"node_modules/uport-transports/lib/transport/messageServer.js","original":{"line":15,"column":0},"generated":{"line":15,"column":0}},{"source":"node_modules/uport-transports/lib/transport/messageServer.js","original":{"line":16,"column":0},"generated":{"line":16,"column":0}},{"source":"node_modules/uport-transports/lib/transport/messageServer.js","original":{"line":17,"column":0},"generated":{"line":17,"column":0}},{"source":"node_modules/uport-transports/lib/transport/messageServer.js","original":{"line":18,"column":0},"generated":{"line":18,"column":0}},{"source":"node_modules/uport-transports/lib/transport/messageServer.js","original":{"line":19,"column":0},"generated":{"line":19,"column":0}},{"source":"node_modules/uport-transports/lib/transport/messageServer.js","original":{"line":20,"column":0},"generated":{"line":20,"column":0}},{"source":"node_modules/uport-transports/lib/transport/messageServer.js","original":{"line":21,"column":0},"generated":{"line":21,"column":0}},{"source":"node_modules/uport-transports/lib/transport/messageServer.js","original":{"line":22,"column":0},"generated":{"line":22,"column":0}},{"source":"node_modules/uport-transports/lib/transport/messageServer.js","original":{"line":23,"column":0},"generated":{"line":23,"column":0}},{"source":"node_modules/uport-transports/lib/transport/messageServer.js","original":{"line":24,"column":0},"generated":{"line":24,"column":0}},{"source":"node_modules/uport-transports/lib/transport/messageServer.js","original":{"line":25,"column":0},"generated":{"line":25,"column":0}},{"source":"node_modules/uport-transports/lib/transport/messageServer.js","original":{"line":26,"column":0},"generated":{"line":26,"column":0}},{"source":"node_modules/uport-transports/lib/transport/messageServer.js","original":{"line":27,"column":0},"generated":{"line":27,"column":0}},{"source":"node_modules/uport-transports/lib/transport/messageServer.js","original":{"line":28,"column":0},"generated":{"line":28,"column":0}},{"source":"node_modules/uport-transports/lib/transport/messageServer.js","original":{"line":29,"column":0},"generated":{"line":29,"column":0}},{"source":"node_modules/uport-transports/lib/transport/messageServer.js","original":{"line":30,"column":0},"generated":{"line":30,"column":0}},{"source":"node_modules/uport-transports/lib/transport/messageServer.js","original":{"line":31,"column":0},"generated":{"line":31,"column":0}},{"source":"node_modules/uport-transports/lib/transport/messageServer.js","original":{"line":32,"column":0},"generated":{"line":32,"column":0}},{"source":"node_modules/uport-transports/lib/transport/messageServer.js","original":{"line":33,"column":0},"generated":{"line":33,"column":0}},{"source":"node_modules/uport-transports/lib/transport/messageServer.js","original":{"line":34,"column":0},"generated":{"line":34,"column":0}},{"source":"node_modules/uport-transports/lib/transport/messageServer.js","original":{"line":35,"column":0},"generated":{"line":35,"column":0}},{"source":"node_modules/uport-transports/lib/transport/messageServer.js","original":{"line":36,"column":0},"generated":{"line":36,"column":0}},{"source":"node_modules/uport-transports/lib/transport/messageServer.js","original":{"line":37,"column":0},"generated":{"line":37,"column":0}},{"source":"node_modules/uport-transports/lib/transport/messageServer.js","original":{"line":38,"column":0},"generated":{"line":38,"column":0}},{"source":"node_modules/uport-transports/lib/transport/messageServer.js","original":{"line":39,"column":0},"generated":{"line":39,"column":0}},{"source":"node_modules/uport-transports/lib/transport/messageServer.js","original":{"line":40,"column":0},"generated":{"line":40,"column":0}},{"source":"node_modules/uport-transports/lib/transport/messageServer.js","original":{"line":41,"column":0},"generated":{"line":41,"column":0}},{"source":"node_modules/uport-transports/lib/transport/messageServer.js","original":{"line":42,"column":0},"generated":{"line":42,"column":0}},{"source":"node_modules/uport-transports/lib/transport/messageServer.js","original":{"line":43,"column":0},"generated":{"line":43,"column":0}},{"source":"node_modules/uport-transports/lib/transport/messageServer.js","original":{"line":44,"column":0},"generated":{"line":44,"column":0}},{"source":"node_modules/uport-transports/lib/transport/messageServer.js","original":{"line":45,"column":0},"generated":{"line":45,"column":0}},{"source":"node_modules/uport-transports/lib/transport/messageServer.js","original":{"line":46,"column":0},"generated":{"line":46,"column":0}},{"source":"node_modules/uport-transports/lib/transport/messageServer.js","original":{"line":47,"column":0},"generated":{"line":47,"column":0}},{"source":"node_modules/uport-transports/lib/transport/messageServer.js","original":{"line":48,"column":0},"generated":{"line":48,"column":0}},{"source":"node_modules/uport-transports/lib/transport/messageServer.js","original":{"line":49,"column":0},"generated":{"line":49,"column":0}},{"source":"node_modules/uport-transports/lib/transport/messageServer.js","original":{"line":50,"column":0},"generated":{"line":50,"column":0}},{"source":"node_modules/uport-transports/lib/transport/messageServer.js","original":{"line":51,"column":0},"generated":{"line":51,"column":0}},{"source":"node_modules/uport-transports/lib/transport/messageServer.js","original":{"line":52,"column":0},"generated":{"line":52,"column":0}},{"source":"node_modules/uport-transports/lib/transport/messageServer.js","original":{"line":53,"column":0},"generated":{"line":53,"column":0}},{"source":"node_modules/uport-transports/lib/transport/messageServer.js","original":{"line":54,"column":0},"generated":{"line":54,"column":0}},{"source":"node_modules/uport-transports/lib/transport/messageServer.js","original":{"line":55,"column":0},"generated":{"line":55,"column":0}},{"source":"node_modules/uport-transports/lib/transport/messageServer.js","original":{"line":56,"column":0},"generated":{"line":56,"column":0}},{"source":"node_modules/uport-transports/lib/transport/messageServer.js","original":{"line":57,"column":0},"generated":{"line":57,"column":0}},{"source":"node_modules/uport-transports/lib/transport/messageServer.js","original":{"line":58,"column":0},"generated":{"line":58,"column":0}},{"source":"node_modules/uport-transports/lib/transport/messageServer.js","original":{"line":59,"column":0},"generated":{"line":59,"column":0}},{"source":"node_modules/uport-transports/lib/transport/messageServer.js","original":{"line":60,"column":0},"generated":{"line":60,"column":0}},{"source":"node_modules/uport-transports/lib/transport/messageServer.js","original":{"line":61,"column":0},"generated":{"line":61,"column":0}},{"source":"node_modules/uport-transports/lib/transport/messageServer.js","original":{"line":62,"column":0},"generated":{"line":62,"column":0}},{"source":"node_modules/uport-transports/lib/transport/messageServer.js","original":{"line":63,"column":0},"generated":{"line":63,"column":0}},{"source":"node_modules/uport-transports/lib/transport/messageServer.js","original":{"line":64,"column":0},"generated":{"line":64,"column":0}},{"source":"node_modules/uport-transports/lib/transport/messageServer.js","original":{"line":65,"column":0},"generated":{"line":65,"column":0}},{"source":"node_modules/uport-transports/lib/transport/messageServer.js","original":{"line":66,"column":0},"generated":{"line":66,"column":0}},{"source":"node_modules/uport-transports/lib/transport/messageServer.js","original":{"line":67,"column":0},"generated":{"line":67,"column":0}},{"source":"node_modules/uport-transports/lib/transport/messageServer.js","original":{"line":68,"column":0},"generated":{"line":68,"column":0}},{"source":"node_modules/uport-transports/lib/transport/messageServer.js","original":{"line":69,"column":0},"generated":{"line":69,"column":0}},{"source":"node_modules/uport-transports/lib/transport/messageServer.js","original":{"line":70,"column":0},"generated":{"line":70,"column":0}},{"source":"node_modules/uport-transports/lib/transport/messageServer.js","original":{"line":71,"column":0},"generated":{"line":71,"column":0}},{"source":"node_modules/uport-transports/lib/transport/messageServer.js","original":{"line":72,"column":0},"generated":{"line":72,"column":0}},{"source":"node_modules/uport-transports/lib/transport/messageServer.js","original":{"line":73,"column":0},"generated":{"line":73,"column":0}},{"source":"node_modules/uport-transports/lib/transport/messageServer.js","original":{"line":74,"column":0},"generated":{"line":74,"column":0}},{"source":"node_modules/uport-transports/lib/transport/messageServer.js","original":{"line":75,"column":0},"generated":{"line":75,"column":0}},{"source":"node_modules/uport-transports/lib/transport/messageServer.js","original":{"line":76,"column":0},"generated":{"line":76,"column":0}},{"source":"node_modules/uport-transports/lib/transport/messageServer.js","original":{"line":77,"column":0},"generated":{"line":77,"column":0}},{"source":"node_modules/uport-transports/lib/transport/messageServer.js","original":{"line":78,"column":0},"generated":{"line":78,"column":0}},{"source":"node_modules/uport-transports/lib/transport/messageServer.js","original":{"line":79,"column":0},"generated":{"line":79,"column":0}},{"source":"node_modules/uport-transports/lib/transport/messageServer.js","original":{"line":80,"column":0},"generated":{"line":80,"column":0}},{"source":"node_modules/uport-transports/lib/transport/messageServer.js","original":{"line":81,"column":0},"generated":{"line":81,"column":0}},{"source":"node_modules/uport-transports/lib/transport/messageServer.js","original":{"line":82,"column":0},"generated":{"line":82,"column":0}},{"source":"node_modules/uport-transports/lib/transport/messageServer.js","original":{"line":83,"column":0},"generated":{"line":83,"column":0}},{"source":"node_modules/uport-transports/lib/transport/messageServer.js","original":{"line":84,"column":0},"generated":{"line":84,"column":0}},{"source":"node_modules/uport-transports/lib/transport/messageServer.js","original":{"line":85,"column":0},"generated":{"line":85,"column":0}},{"source":"node_modules/uport-transports/lib/transport/messageServer.js","original":{"line":86,"column":0},"generated":{"line":86,"column":0}},{"source":"node_modules/uport-transports/lib/transport/messageServer.js","original":{"line":87,"column":0},"generated":{"line":87,"column":0}},{"source":"node_modules/uport-transports/lib/transport/messageServer.js","original":{"line":88,"column":0},"generated":{"line":88,"column":0}},{"source":"node_modules/uport-transports/lib/transport/messageServer.js","original":{"line":89,"column":0},"generated":{"line":89,"column":0}},{"source":"node_modules/uport-transports/lib/transport/messageServer.js","original":{"line":90,"column":0},"generated":{"line":90,"column":0}},{"source":"node_modules/uport-transports/lib/transport/messageServer.js","original":{"line":91,"column":0},"generated":{"line":91,"column":0}},{"source":"node_modules/uport-transports/lib/transport/messageServer.js","original":{"line":92,"column":0},"generated":{"line":92,"column":0}},{"source":"node_modules/uport-transports/lib/transport/messageServer.js","original":{"line":93,"column":0},"generated":{"line":93,"column":0}},{"source":"node_modules/uport-transports/lib/transport/messageServer.js","original":{"line":94,"column":0},"generated":{"line":94,"column":0}},{"source":"node_modules/uport-transports/lib/transport/messageServer.js","original":{"line":95,"column":0},"generated":{"line":95,"column":0}},{"source":"node_modules/uport-transports/lib/transport/messageServer.js","original":{"line":96,"column":0},"generated":{"line":96,"column":0}},{"source":"node_modules/uport-transports/lib/transport/messageServer.js","original":{"line":97,"column":0},"generated":{"line":97,"column":0}},{"source":"node_modules/uport-transports/lib/transport/messageServer.js","original":{"line":98,"column":0},"generated":{"line":98,"column":0}},{"source":"node_modules/uport-transports/lib/transport/messageServer.js","original":{"line":99,"column":0},"generated":{"line":99,"column":0}},{"source":"node_modules/uport-transports/lib/transport/messageServer.js","original":{"line":100,"column":0},"generated":{"line":100,"column":0}},{"source":"node_modules/uport-transports/lib/transport/messageServer.js","original":{"line":101,"column":0},"generated":{"line":101,"column":0}},{"source":"node_modules/uport-transports/lib/transport/messageServer.js","original":{"line":102,"column":0},"generated":{"line":102,"column":0}},{"source":"node_modules/uport-transports/lib/transport/messageServer.js","original":{"line":103,"column":0},"generated":{"line":103,"column":0}},{"source":"node_modules/uport-transports/lib/transport/messageServer.js","original":{"line":104,"column":0},"generated":{"line":104,"column":0}},{"source":"node_modules/uport-transports/lib/transport/messageServer.js","original":{"line":105,"column":0},"generated":{"line":105,"column":0}},{"source":"node_modules/uport-transports/lib/transport/messageServer.js","original":{"line":106,"column":0},"generated":{"line":106,"column":0}},{"source":"node_modules/uport-transports/lib/transport/messageServer.js","original":{"line":107,"column":0},"generated":{"line":107,"column":0}},{"source":"node_modules/uport-transports/lib/transport/messageServer.js","original":{"line":108,"column":0},"generated":{"line":108,"column":0}},{"source":"node_modules/uport-transports/lib/transport/messageServer.js","original":{"line":109,"column":0},"generated":{"line":109,"column":0}},{"source":"node_modules/uport-transports/lib/transport/messageServer.js","original":{"line":110,"column":0},"generated":{"line":110,"column":0}},{"source":"node_modules/uport-transports/lib/transport/messageServer.js","original":{"line":111,"column":0},"generated":{"line":111,"column":0}},{"source":"node_modules/uport-transports/lib/transport/messageServer.js","original":{"line":112,"column":0},"generated":{"line":112,"column":0}},{"source":"node_modules/uport-transports/lib/transport/messageServer.js","original":{"line":113,"column":0},"generated":{"line":113,"column":0}},{"source":"node_modules/uport-transports/lib/transport/messageServer.js","original":{"line":114,"column":0},"generated":{"line":114,"column":0}},{"source":"node_modules/uport-transports/lib/transport/messageServer.js","original":{"line":115,"column":0},"generated":{"line":115,"column":0}},{"source":"node_modules/uport-transports/lib/transport/messageServer.js","original":{"line":116,"column":0},"generated":{"line":116,"column":0}},{"source":"node_modules/uport-transports/lib/transport/messageServer.js","original":{"line":117,"column":0},"generated":{"line":117,"column":0}},{"source":"node_modules/uport-transports/lib/transport/messageServer.js","original":{"line":118,"column":0},"generated":{"line":118,"column":0}},{"source":"node_modules/uport-transports/lib/transport/messageServer.js","original":{"line":119,"column":0},"generated":{"line":119,"column":0}},{"source":"node_modules/uport-transports/lib/transport/messageServer.js","original":{"line":120,"column":0},"generated":{"line":120,"column":0}},{"source":"node_modules/uport-transports/lib/transport/messageServer.js","original":{"line":121,"column":0},"generated":{"line":121,"column":0}},{"source":"node_modules/uport-transports/lib/transport/messageServer.js","original":{"line":122,"column":0},"generated":{"line":122,"column":0}},{"source":"node_modules/uport-transports/lib/transport/messageServer.js","original":{"line":123,"column":0},"generated":{"line":123,"column":0}},{"source":"node_modules/uport-transports/lib/transport/messageServer.js","original":{"line":124,"column":0},"generated":{"line":124,"column":0}},{"source":"node_modules/uport-transports/lib/transport/messageServer.js","original":{"line":125,"column":0},"generated":{"line":125,"column":0}},{"source":"node_modules/uport-transports/lib/transport/messageServer.js","original":{"line":126,"column":0},"generated":{"line":126,"column":0}},{"source":"node_modules/uport-transports/lib/transport/messageServer.js","original":{"line":127,"column":0},"generated":{"line":127,"column":0}},{"source":"node_modules/uport-transports/lib/transport/messageServer.js","original":{"line":128,"column":0},"generated":{"line":128,"column":0}},{"source":"node_modules/uport-transports/lib/transport/messageServer.js","original":{"line":129,"column":0},"generated":{"line":129,"column":0}},{"source":"node_modules/uport-transports/lib/transport/messageServer.js","original":{"line":130,"column":0},"generated":{"line":130,"column":0}},{"source":"node_modules/uport-transports/lib/transport/messageServer.js","original":{"line":131,"column":0},"generated":{"line":131,"column":0}},{"source":"node_modules/uport-transports/lib/transport/messageServer.js","original":{"line":132,"column":0},"generated":{"line":132,"column":0}},{"source":"node_modules/uport-transports/lib/transport/messageServer.js","original":{"line":133,"column":0},"generated":{"line":133,"column":0}},{"source":"node_modules/uport-transports/lib/transport/messageServer.js","original":{"line":134,"column":0},"generated":{"line":134,"column":0}},{"source":"node_modules/uport-transports/lib/transport/messageServer.js","original":{"line":135,"column":0},"generated":{"line":135,"column":0}},{"source":"node_modules/uport-transports/lib/transport/messageServer.js","original":{"line":136,"column":0},"generated":{"line":136,"column":0}},{"source":"node_modules/uport-transports/lib/transport/messageServer.js","original":{"line":137,"column":0},"generated":{"line":137,"column":0}},{"source":"node_modules/uport-transports/lib/transport/messageServer.js","original":{"line":138,"column":0},"generated":{"line":138,"column":0}},{"source":"node_modules/uport-transports/lib/transport/messageServer.js","original":{"line":139,"column":0},"generated":{"line":139,"column":0}}],"sources":{"node_modules/uport-transports/lib/transport/messageServer.js":"'use strict';\n\nObject.defineProperty(exports, \"__esModule\", {\n  value: true\n});\nexports.CHASQUI_URL = exports.isMessageServerCallback = exports.genCallback = exports.clearResponse = exports.poll = exports.URIHandlerSend = undefined;\n\nvar _util = require('./../message/util.js');\n\nvar _crypto = require('./../crypto.js');\n\nvar _poll = require('./poll.js');\n\nvar _poll2 = _interopRequireDefault(_poll);\n\nvar _didJwt = require('did-jwt');\n\nvar _nets = require('nets');\n\nvar _nets2 = _interopRequireDefault(_nets);\n\nfunction _interopRequireDefault(obj) { return obj && obj.__esModule ? obj : { default: obj }; }\n\nvar CHASQUI_URL = 'https://api.uport.space/chasqui/';\nvar POLLING_INTERVAL = 2000;\n\n// TODO can the name of URIHandler be changed\n// TODO should it just allow cancel func to be passed in??\n// TODO Should it return uri append to promise? instead of a promise??\n/**\n *  A general Chasqui Transport. Allows you to configure the transport with any uriHandler for the request,\n *  while the response will always be returned through Chasqui. Chasqui is a simple messaging server that\n *  allows responses to be relayed from a uport client to the original callee.\n *\n *  @param    {String}       uriHandler               a function called with the requestURI once it is formatted for this transport\n *  @param    {Object}       [config={}]              an optional config object\n *  @param    {String}       [config.chasquiUrl]      url of messaging server, defaults to Chasqui instance run by uPort\n *  @param    {String}       [config.pollingInterval] milisecond interval at which the messaging server will be polled for a response\n *  @return   {Function}                              a configured QRTransport Function\n *  @param    {String}       message                  a uPort client request message\n *  @return   {Promise<Object, Error>}                a function to close the QR modal\n */\nvar URIHandlerSend = function URIHandlerSend(uriHandler) {\n  var _ref = arguments.length > 1 && arguments[1] !== undefined ? arguments[1] : {},\n      _ref$messageServerUrl = _ref.messageServerUrl,\n      messageServerUrl = _ref$messageServerUrl === undefined ? CHASQUI_URL : _ref$messageServerUrl,\n      _ref$pollingInterval = _ref.pollingInterval,\n      pollingInterval = _ref$pollingInterval === undefined ? POLLING_INTERVAL : _ref$pollingInterval;\n\n  if (!uriHandler) throw new Error('uriHandler function required');\n  return function (message) {\n    var params = arguments.length > 1 && arguments[1] !== undefined ? arguments[1] : {};\n\n    var uri = (0, _util.messageToURI)(message);\n    var callback = getCallback(uri);\n    if (!isMessageServerCallback(uri, messageServerUrl)) throw new Error('Not a request that can be handled by this configured messaging server transport');\n    var isCancelled = false;\n    var cancel = function cancel() {\n      isCancelled = true;\n    };\n    uri = (0, _util.paramsToQueryString)(uri, { callback_type: 'post' });\n    uriHandler(uri, Object.assign(params, { cancel: cancel }));\n    var returnVal = poll(callback, pollingInterval, function () {\n      return isCancelled;\n    });\n    returnVal.cancel = cancel;\n    return returnVal;\n  };\n};\n\n/**\n *  A polling function specifically for polling Chasqui.\n *\n *  @param    {String}                  url                a Chasqui url polled\n *  @param    {Integer}                 [pollingInterval]  ms interval at which the given url is polled\n *  @param    {Function}                [cancelled]        function which returns boolean, if returns true, polling stops\n *  @return   {Promise<Object, Error>}                     a promise which resolves with obj/message or rejects with an error\n */\nvar poll = function poll(url, pollingInterval, cancelled) {\n  var messageParse = function messageParse(res) {\n    // Support new and old chasqui format\n    var message = res.message && ('content' in res.message ? JSON.parse(res.message.content) : res.message);\n    // FIXME: this is not a great method for handling our expected keys in the response.\n    //        Very tightly coupled to the message format, and these keys seem to come out\n    //        of nowhere.\n    if (message) {\n      return message['access_token'] || message['tx'] || message['typedDataSig'] || message['personalSig'];\n    }\n  };\n  var errorParse = function errorParse(res) {\n    if (res.message) return res.message.error;\n  };\n  return (0, _poll2.default)(url, messageParse, errorParse, cancelled, pollingInterval).then(function (res) {\n    clearResponse(url);\n    return res;\n  });\n};\n\n// TODO maybe remove and just have reasonable removal times\nvar clearResponse = function clearResponse(url) {\n  (0, _nets2.default)({\n    uri: url,\n    method: 'DELETE',\n    withCredentials: false,\n    rejectUnauthorized: false\n  }, function (err) {\n    if (err) {\n      throw err;\n    } /* Errors without this cb */\n  });\n};\n\nvar formatMessageServerUrl = function formatMessageServerUrl(url) {\n  if (url.endsWith('/topic/')) return url;\n  if (url.endsWith('/topic')) return url + '/';\n  if (url.endsWith('/')) return url + 'topic/';\n  return url + '/topic/';\n};\nvar genCallback = function genCallback() {\n  var messageServerUrl = arguments.length > 0 && arguments[0] !== undefined ? arguments[0] : CHASQUI_URL;\n  return '' + formatMessageServerUrl(messageServerUrl) + (0, _crypto.randomString)(16);\n};\nvar isMessageServerCallback = function isMessageServerCallback(uri) {\n  var messageServerUrl = arguments.length > 1 && arguments[1] !== undefined ? arguments[1] : CHASQUI_URL;\n  return new RegExp(formatMessageServerUrl(messageServerUrl)).test(getCallback(uri));\n};\nvar getCallback = function getCallback(uri) {\n  var tokenCB = (0, _didJwt.decodeJWT)((0, _util.getURLJWT)(uri)).payload.callback;\n  if (tokenCB) return tokenCB;\n  // support attest req, which does not included cb in token, attest req may better align with other requests in the future\n  return (0, _util.getUrlQueryParams)(uri).callback_url;\n};\n\nexports.URIHandlerSend = URIHandlerSend;\nexports.poll = poll;\nexports.clearResponse = clearResponse;\nexports.genCallback = genCallback;\nexports.isMessageServerCallback = isMessageServerCallback;\nexports.CHASQUI_URL = CHASQUI_URL;"},"lineCount":139}},"hash":"3b8dfcd921f0ef8071f46ef5209f1bd1","cacheData":{"env":{}}}